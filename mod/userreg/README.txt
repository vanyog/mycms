Модул за саморегистрирани потребители
=====================================

Изисквания и първоначални настройки
-----------------------------------
Модулът използва същата база данни, която ползва и модул user, ето защо за да може да се ползва
този модул, модул user и изискваният от user модул usermenu трябва да са инсталирани.

Във формата за саморегистриране се ползва reCaptcha, така че собственикът на сайта трябва да разполага с публичен и персонален ключ, получени от https://www.google.com/recaptcha

Тези ключове трябва да са записани в таблица $tn_prefix.'options' с имена 'recaptcha_pub' и 'recaptcha_private'.

Саморегистриращите се потребители се разделят на типове. Типът на всеки потребител е кратък стринг,
който при своята работа модулът записва в полето `type` на таблица $user_table.

Модулът изисква за всеки тип потребители да се добавят три настройки в таблица $tn_prefix.'options':

userreg_login_xxx - адрес на страницата, показваща форма за влизане на потребител;
userreg_logout_xxx - адрес на страницата, показваща се след излизане на потребител;
userreg_newreg_xxx - адрес на страницата, показваща форма за саморегистриране на нов потребител, която се използва и за смяна на паролата на вече регистриран потребител.

xxx в имената на тези настройки трябва да съвпада с типа потребители.

Трите настройки могат да посочват страница с един и същи номер, с добавен параметър user2 със съответни стойности, например, ако номерът на страницата за влизане е 111, стойността

на userreg_login_xxx може да е: /index.php?pid=111&user2=login,
на userreg_logout_xxx - /index.php?pid=111&user2=logout и
на userreg_newreg_xxx - /index.php?pid=111&user2=newreg.

Настоящият модул на мястото на елементите:

<!--$$_USERREG_xxxx[|yyy]_$$-->

в които xxxx трябва да е типът потребители, показва различни формуляри за обслужване на потребители
от посочения тип. Наличието на тип в горния елемент е задължително, отсъствието на тип, предизвиква 
прекъсване със съобщение за грешка.

Поставянето на този елемент, придружен само от име на тип потребители, ограничава достъпа до страницата само за потребители от този тип. Ако няма влязъл потребител от този тип, става препращане към страницата за влизане и след успешно влизане, става връщане и показване съдържанието на защитената страница.

Незадължителния, отделен със символ | втори параметър
----------------------------------------------------
ако е добавен, трябва да бъде със стойност:

'logout' - за да се покаже потребителското име на влезлия потребител и линк "Изход". Това може да се използва във всички страници, на които само трябва да се вижда дали има влязъл потребител и кой е той, и влезлият потребител да има на разположение линк, през който, той може да излезе ако реши.

число - номер на страница, на която трябва да се отиде, ако има влязъл потребител; Това се използва, ако страницата е предназначена за извършване на действията определени с параметъра $_GET['user2'], описани по-долу и страницата би се показала празна, ако не получи параметър с име user2.

Параметър $_GET['user2']
------------------------
Позволените стойности на този параметър са:

newreg - за показване на форма за нова регистрация или смяна на паролата
login - за показване на форма за влизане
logout - за излизане на потребителя и пренасочване към страницата, зададена в настройката userreg_logout_xxx
edit - редактиране на данните

Параметър user2=edit може да се съчетае с uid=НомерНаПотребител. Тогава се редактират данните на потребителя с посочения номер, но само ако влезлият потребител има право да управлява модула.

Контрол на достъпа
------------------
На страница, която трябва да е достъпна само за потребители от определен тип се слага елемент:
<!--$$_USERREG_xxxx_$$-->
Когато няма изпратен $_GET['user2'] параметър се осъществява само контрол на достъпа. Ако поне една от 
променливите $_SESSION['user2_username'], $_SESSION['user2_password'] и $_SESSION['user2_type'] не е 
установена, на $_SESSION['user2_returnpage'] се присвоява адреса на текущата страница и се извършва 
пренасочване към страницата за влизане, зададена в таблица $tn_prefix.'options' с име 'userreg_login_xxxx',
където xxxx е типът потребители. За разлика от модул user, модул userreg никога не генерира Access denied, 
а само пренасочва към страницата за влизане. Ако променливите в сесията съответстват на съществуващ запис от 
таблица user_table (влязъл е валиден потребител), функцията връща празен стринг, така се дава възможност да се 
покаже само съдържанието на страницата, до която трябва да имат достъп само регистрирани потребители.

Показване потребителското име и линк "Изход"
--------------------------------------------
На всяка страница от сайта, където трябва да се вижда потребителското име на влезлия потребител и линк "Изход" са вмъква:
<!--$$_USERREG_xxxx|logout_$$-->. За разлика от модул user, който винаги, при наличие на валиден влязъл 
потребител връща потребителско име и линк "Изход", модул userreg връща празен стринг. Затова на всички 
страници, където трябва да се показват потребителско име и линк "Изход", трябва да се използва елемент:
<!--$$_USERREG_xxxx|logout_$$-->.

Нова регистрация
----------------
Формата за нова регистрация се използва и за възстановяване на забравена парола.
След попълване и изпращане на данните: имейл адрес и парола се проверява дали в таблица $user_table има 
запис с такъв имейл адрес, парола и тип потребител. Ако няма се вмъква нов запис, а ако има се променя 
съществуващия запис. Генерира се код от случайни символи, който се записва в поле `code` на записа, 
а паролата се записва в поле `newpass`. Изпраща се имейл в който е посочен адреса на страницата за 
регистриране с добавен към него параметър code. След като потребителят отвори, изпратения адрес, полетата 
на записа в таблица $user_table се променят така: `username`=`email`, `password`=`newpass`, `newpass`='' и 
`code`=''.

Влизане
-------
При влизане потребителят въвежда имейл адрес и парола. Ако в таблица $user_table има потребител от 
съответния тип с тези данни, се запазват следните променливи: $_SESSION['user2_username'], 
$_SESSION['user2_password'] и $_SESSION['user2_type'] и се извършва пренасочване към страница
$_SESSION['user2_returnpage'], ако е зададена, или се презарежда същата страница.

Излизане
--------
Страницата за излизане се задава с настройката 'userreg_logout_xxxx'. В адресът й трябва да съдържа параметър
user2=logout, а в текста й - елемент <!--$$_USERREG_xxxx_$$-->.

