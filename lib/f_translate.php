<?php

/*
MyCMS - a simple Content Management System
Copyright (C) 2012  Vanyo Georgiev <info@vanyog.com>

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/

// Функцията translate($n,$elink) връща текст с име $n на езика, определен с глобалната променлива $language.

// Ако в таблица `content` на базата данни няма такъв текст,
// на локален сървър или в режим на редактиране 
// на мястото на текста се показва хипервръзка към страница за вмъкване на текст,
// но на онлайн сървър в работен режим, функцията връща текст на подразбиращия се език.

// Ако вторият параметър $elink = false, в режим на редактиране в края на надписа не се показва линк за редактиране,
// иначе този ленк не се показва ако полето от записа на надписа nolink е 1.

include_once($idir."conf_paths.php");
include_once($idir."lib/f_is_local.php");
include_once($idir."lib/f_db_select_1.php");
include_once($idir."lib/f_parse_content.php");

$content_date_time    = '';// Променлива, която съдържа датата и часа на последната редакция на върнатия текст 
$content_create_time = ''; // Променлива, която съдържа датата и часа на първото въвеждане на върнатия текст 
$global_filters = db_table_field('filters', 'filters', "`name` LIKE '*'");

function translate($n, $elink=true){

global $languages, $default_language, $language, $pth, $adm_pth, $content_date_time, $content_create_time, $can_edit,
       $page_content, $page_data, $debug_mode, $tn_prefix;

// Статична променлива за кеш
static $string = array();

// Ако стрингът вече е съставен се връща от кеша
if (isset($string[$n][$language]) && !in_edit_mode()) return $string[$n][$language];

//if( !empty($debug_mode) ) echo "$n ";

$content_date_time = '';
$content_create_time = '';

$el = ''; // Линк за редактиране. Показва се ако сайтът е в режим на редактиране.
if (in_edit_mode() && $elink){
  $id = db_select_1('ID','content',"name='$n' AND language='$language'");
  if ($can_edit) $h = $pth.'mod/usermenu/edit_text.php?i='.$id['ID'].'&amp;pid='.$page_data['ID'];
  else $h = $adm_pth.'edit_record.php?t=content&amp;r='.$id['ID'];
  $el = '<a href="'.$h.'" style="color:#000000;background-color:#ffffff;margin:0;padding:0;">*</a>';
}

// Връщан резултат
$rz = '';

// Четене на записа за надпис с име $n на език $language
$r1 = db_select_1('c.*, f.filters',
                  'content` c LEFT JOIN `'.$tn_prefix.'filters` f ON c.name=f.`name', "c.name='$n' AND `language`='$language'");

if ($r1){ // Ако има такъв запис
  $content_create_time = $r1['date_time_1'];
  $content_date_time = $r1['date_time_2'];
  $t = stripslashes($r1['text']);
  $rz = apply_filters($r1['filters'], parse_content($t));
  if ((!isset($r1['nolink']) || !$r1['nolink']) && $elink) $rz .= $el;
}
else if (in_edit_mode() && $elink){
         // На локелен сървър или в режим на редактиране се показва името на стринга като линк,
         // който отваря форма за въвеждане на липсващия надпис
         if ($can_edit) $h = $pth.'mod/usermenu/edit_text.php?i='.$n.
             '&amp;lang='.$language.
             '&amp;pid='.$page_data['ID'];
         else $h = $adm_pth."new_content.php?n=$n&l=$language";
         return "<a href=\"$h\">$n</a>";
     }
     else { // На отдалечен сървър в работен режим
         // Ако сме на езика по подразбиране и има други езици
         if(($language == $default_language) && count($languages)) {
             // Стринг на произволен език
             $r2 = db_select_1('c.*, f.filters', 'content` c LEFT JOIN `'.$tn_prefix.'filters` f ON c.name=f.`name', "c.name='$n'");
         }
         // Четене на записа на езика по подразбиране
         else $r2 = db_select_1('c.*, f.filters', 'content` c LEFT JOIN `'.$tn_prefix.'filters` f ON c.name=f.`name', "c.name='$n' AND `language`='$default_language'");
         // Ако няма запис се показва името на текста
         if ( !$r2 ){ $r2['text'] = $n; $r2['filters'] = ''; }
         else {
           $content_create_time = $r2['date_time_1'];
           $content_date_time = $r2['date_time_2'];
         }
         $t = stripslashes($r2['text']);
         // Заместват се със съдържание евентуални <!--$$_XXX_$$--> елементи
         $rz = apply_filters($r2['filters'], parse_content($t));
     }
// Запазване в кеш
$string[$n][$language] = $rz;

// Връщане на резултата
return $rz;

} // Край на функцията translate($n)

// Функцията apply_filters($n, $t) прилага върху текста $t, определените за текста с име $n филтри

function apply_filters($fs, $t){
global $idir, $adm_pth;
$rz = $t; // Връщан резултат
// Масив от имена на филтри
$fla = array();
if ($fs) $fla = explode(',', $fs);
// Прилагане на списъка от филтри      
foreach($fla as $fln){
  $flp = "filter/$fln/$fln.php"; // Път до файла на филтъра от директорията на сайта
  $afp = "$idir$flp"; // Абсолютен път до файла на филтъра
  if (file_exists($afp)){ // Ако има такъв филтър
    include_once($afp);
    if(isset($fl['param']) && ($fl['param']>" ")) $rz = $fln($rz, $fl['param']);
    else $rz = $fln($rz);
  }
  else // При администриране се показва линк за създаване на филтър
    if (show_adm_links()) $rz .= '<p><br>Unknown fliter <a href="'.$adm_pth.'new_filter.php?f='.$fln.'">'.$fln.'</a><p>';
}
return $rz;
} 

?>
